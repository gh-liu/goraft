# raft

Raft 是一个共识算法，用于分布式系统中复制日志。

将问题拆为主要两部分：
1. 领导选举
2. 日志复制

领导节点选举出来后，客户端请求领导节点，领导节点请求到其他节点进行日志复制。

客户端 --> 领导节点 --> 集群内其他节点


## 1. 领导选举

1. 节点有三个角色：跟随者节点、候选者节点、领导节点
2. 每个跟随者节点，在一个随机的超时时间过去后，转换为候选者节点，同时向集群内其他节点请求投票
3. 某个候选者节点获取到集群内大多数节点的投票时，转换为领导节点
4. 领导节点开始给集群内其他节点发送心跳：当跟随者节点或候选者节点收到领导心跳时，变为跟随者节点，超时时间重新开始


## 2. 日志复制

1. 客户端请求领导节点，有修改命令
2. 领导节点请求集群内其他节点，复制日志
3. 领导节点判断集群内是否大多数节点已经完成日志复制，是则应用命令
4. 响应客户端

## 两个RPC请求的实现细节

> 1. 候选者节点请求集群内其他节点进行投票，其他节点如何判断是否赞成？
> 主要是lastLogIndex和lastLogTerm字段

1. 候选者节点的term，比当前节点的term要新
2. 候选者节点的日志，比当前节点的日志要新：候选者最新term索引大于当前节点term，或term相同但索引大

> 2. 领导者节点请求集群内其他节点追加日志，其他节点如何判断是否追加？如何追加？
> 主要是prevLogIndex和prevLogTerm字段

1. 领导节点的term，要和当前节点的term一致
2. 领导节点的要提交的日志PrevLogIndex开始，如何term不一致，则覆盖，一致则忽略


[1]: https://notes.eatonphil.com/2023-05-25-raft.html
[2]: https://github.com/eatonphil/goraft
